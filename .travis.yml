# This Travis job script has been generated by a script via
#
#   haskell-ci '--output=.travis.yml' '--config=cabal.haskell-ci' 'cabal.project'
#
# For more information, see https://github.com/haskell-CI/haskell-ci
#
# version: 0.3.20190521
#
# This file is patched:
# - We install the typediff utility from its repoistory.
# - We amend the cabal.project with the BATTERIES environment variable.
#   When BATTERIES=NO is set, we exclude the `base-compat-batteries` and
#   `check` package/directories from the build.
#   We assume that BATTERIES=NO implies that the tests are disabled as well.
# - These changes are stored in travis.yml.patch.
#
language: c
dist: xenial
git:
  # whether to recursively clone submodules
  submodules: false
cache:
  directories:
    - $HOME/.cabal/packages
    - $HOME/.cabal/store
before_cache:
  - rm -fv $CABALHOME/packages/hackage.haskell.org/build-reports.log
  # remove files that are regenerated by 'cabal update'
  - rm -fv $CABALHOME/packages/hackage.haskell.org/00-index.*
  - rm -fv $CABALHOME/packages/hackage.haskell.org/*.json
  - rm -fv $CABALHOME/packages/hackage.haskell.org/01-index.cache
  - rm -fv $CABALHOME/packages/hackage.haskell.org/01-index.tar
  - rm -fv $CABALHOME/packages/hackage.haskell.org/01-index.tar.idx
  - rm -rfv $CABALHOME/packages/head.hackage
matrix:
  include:
    - compiler: ghc-8.8.1
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-8.8.1","cabal-install-3.0"]}}
      env: GHCHEAD=true
    - compiler: ghc-8.6.5
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-8.6.5","cabal-install-2.4"]}}
    - compiler: ghc-8.6.4
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-8.6.4","cabal-install-2.4"]}}
    - compiler: ghc-8.6.3
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-8.6.3","cabal-install-2.4"]}}
    - compiler: ghc-8.6.2
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-8.6.2","cabal-install-2.4"]}}
    - compiler: ghc-8.6.1
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-8.6.1","cabal-install-2.4"]}}
    - compiler: ghc-8.4.4
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-8.4.4","cabal-install-2.4"]}}
    - compiler: ghc-8.4.3
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-8.4.3","cabal-install-2.4"]}}
    - compiler: ghc-8.4.2
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-8.4.2","cabal-install-2.4"]}}
    - compiler: ghc-8.4.1
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-8.4.1","cabal-install-2.4"]}}
    - compiler: ghc-8.2.2
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-8.2.2","cabal-install-2.4"]}}
    - compiler: ghc-8.2.1
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-8.2.1","cabal-install-2.4"]}}
    - compiler: ghc-8.0.2
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-8.0.2","cabal-install-2.4"]}}
    - compiler: ghc-8.0.1
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-8.0.1","cabal-install-2.4"]}}
    - compiler: ghc-7.10.3
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-7.10.3","cabal-install-2.4"]}}
    - compiler: ghc-7.10.2
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-7.10.2","cabal-install-2.4"]}}
    - compiler: ghc-7.10.1
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-7.10.1","cabal-install-2.4"]}}
    - compiler: ghc-7.8.4
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-7.8.4","cabal-install-2.4"]}}
    - compiler: ghc-7.8.3
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-7.8.3","cabal-install-2.4"]}}
    - compiler: ghc-7.8.2
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-7.8.2","cabal-install-2.4"]}}
    - compiler: ghc-7.8.1
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-7.8.1","cabal-install-2.4"]}}
      env: BATTERIES=NO
    - compiler: ghc-7.6.3
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-7.6.3","cabal-install-2.4"]}}
    - compiler: ghc-7.6.2
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-7.6.2","cabal-install-2.4"]}}
    - compiler: ghc-7.6.1
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-7.6.1","cabal-install-2.4"]}}
    - compiler: ghc-7.4.2
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-7.4.2","cabal-install-2.4"]}}
    - compiler: ghc-7.4.1
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-7.4.1","cabal-install-2.4"]}}
    - compiler: ghc-7.2.2
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-7.2.2","cabal-install-2.4"]}}
    - compiler: ghc-7.2.1
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-7.2.1","cabal-install-2.4"]}}
      env: BATTERIES=NO
    - compiler: ghc-7.0.4
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-7.0.4","cabal-install-2.4"]}}
    - compiler: ghc-7.0.3
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-7.0.3","cabal-install-2.4"]}}
    - compiler: ghc-7.0.2
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-7.0.2","cabal-install-2.4"]}}
    - compiler: ghc-7.0.1
      addons: {"apt":{"sources":["hvr-ghc"],"packages":["ghc-7.0.1","cabal-install-2.4"]}}
      env: BATTERIES=NO
  allow_failures:
    - compiler: ghc-8.8.1
before_install:
  - HC=$(echo "/opt/$CC/bin/ghc" | sed 's/-/\//')
  - HCPKG="$HC-pkg"
  - unset CC
  - CABAL=/opt/ghc/bin/cabal
  - CABALHOME=$HOME/.cabal
  # install typediff
  - mkdir -p $HOME/.local/bin
  - curl -L https://github.com/haskell-compat/base-compat/releases/download/typediff-0.1.4/typediff > $HOME/.local/bin/typediff
  - chmod +x $HOME/.local/bin/typediff
  - export PATH="/opt/ghc/bin:$CABALHOME/bin:$HOME/.local/bin:$PATH"
  - TOP=$(pwd)
  - HCNUMVER=$(( $(${HC} --numeric-version|sed -E 's/([0-9]+)\.([0-9]+)\.([0-9]+).*/\1 * 10000 + \2 * 100 + \3/') ))
  - echo $HCNUMVER
  - CABAL="$CABAL -vnormal+nowrap+markoutput"
  - set -o pipefail
install:
  - ${CABAL} --version
  - echo "$(${HC} --version) [$(${HC} --print-project-git-commit-id 2> /dev/null || echo '?')]"
  - TEST=--enable-tests
  - if [ $HCNUMVER -lt 70002 ]  ||  [ $HCNUMVER -ge 70201 ] && [ $HCNUMVER -lt 70202 ]  ||  [ $HCNUMVER -ge 70401 ] && [ $HCNUMVER -lt 70402 ]  ||  [ $HCNUMVER -ge 70801 ] && [ $HCNUMVER -lt 70802 ] ; then TEST=--disable-tests ; fi
  - BENCH=--enable-benchmarks
  - GHCHEAD=${GHCHEAD-false}
  - rm -f $CABALHOME/config
  - |
    echo "verbose: normal +nowrap +markoutput"          >> $CABALHOME/config
    echo "remote-build-reporting: anonymous"            >> $CABALHOME/config
    echo "remote-repo-cache: $CABALHOME/packages"       >> $CABALHOME/config
    echo "logs-dir:          $CABALHOME/logs"           >> $CABALHOME/config
    echo "world-file:        $CABALHOME/world"          >> $CABALHOME/config
    echo "extra-prog-path:   $CABALHOME/bin"            >> $CABALHOME/config
    echo "symlink-bindir:    $CABALHOME/bin"            >> $CABALHOME/config
    echo "installdir:        $CABALHOME/bin"            >> $CABALHOME/config
    echo "build-summary:     $CABALHOME/logs/build.log" >> $CABALHOME/config
    echo "store-dir:         $CABALHOME/store"          >> $CABALHOME/config
    echo "install-dirs user"                            >> $CABALHOME/config
    echo "  prefix: $CABALHOME"                         >> $CABALHOME/config
    echo "repository hackage.haskell.org"               >> $CABALHOME/config
    echo "  url: http://hackage.haskell.org/"           >> $CABALHOME/config
  - |
    if $GHCHEAD; then
    echo "allow-newer: $($HCPKG list --simple-output | sed -E 's/([a-zA-Z-]+)-[0-9.]+/*:\1/g')" >> $CABALHOME/config

    echo "repository head.hackage"                                                        >> $CABALHOME/config
    echo "   url: http://head.hackage.haskell.org/"                                       >> $CABALHOME/config
    echo "   secure: True"                                                                >> $CABALHOME/config
    echo "   root-keys: 07c59cb65787dedfaef5bd5f987ceb5f7e5ebf88b904bbd4c5cbdeb2ff71b740" >> $CABALHOME/config
    echo "              2e8555dde16ebd8df076f1a8ef13b8f14c66bad8eafefd7d9e37d0ed711821fb" >> $CABALHOME/config
    echo "              8f79fd2389ab2967354407ec852cbe73f2e8635793ac446d09461ffb99527f6e" >> $CABALHOME/config
    echo "   key-threshold: 3"                                                            >> $CABALHOME/config
    fi
  - cat $CABALHOME/config
  - rm -fv cabal.project cabal.project.local cabal.project.freeze
  - travis_retry ${CABAL} v2-update -v
  # Generate cabal.project
  - rm -rf cabal.project cabal.project.local cabal.project.freeze
  - touch cabal.project
  - |
    echo 'packages: "./base-compat"' >> cabal.project
    if [ ! "x$BATTERIES" = "xNO" ] ; then (echo 'packages: "./base-compat-batteries"' >> cabal.project; echo 'packages: "./check"' >> cabal.project) ; fi
  - |
    echo "write-ghc-environment-files: always" >> cabal.project
  - "for pkg in $($HCPKG list --simple-output); do echo $pkg | sed 's/-[^-]*$//' | (grep -vE -- '^(base-compat|base-compat-batteries|type-check)$' || true) | sed 's/^/constraints: /' | sed 's/$/ installed/' >> cabal.project.local; done"
  - cat cabal.project || true
  - cat cabal.project.local || true
  - if [ -f "./base-compat/configure.ac" ]; then (cd "./base-compat" && autoreconf -i); fi
  - if [ -f "./base-compat-batteries/configure.ac" ]; then (cd "./base-compat-batteries" && autoreconf -i); fi
  - if [ -f "./check/configure.ac" ]; then (cd "./check" && autoreconf -i); fi
  - ${CABAL} v2-freeze -w ${HC} ${TEST} ${BENCH}
  - "cat cabal.project.freeze | sed -E 's/^(constraints: *| *)//' | sed 's/any.//'"
  - rm  cabal.project.freeze
  - travis_wait ${CABAL} v2-build -w ${HC} ${TEST} ${BENCH} --dep -j2 all
  - travis_wait ${CABAL} v2-build -w ${HC} --disable-tests --disable-benchmarks --dep -j2 all
script:
  - DISTDIR=$(mktemp -d /tmp/dist-test.XXXX)
  # Packaging...
  - ${CABAL} v2-sdist all
  # Unpacking...
  - mv dist-newstyle/sdist/*.tar.gz ${DISTDIR}/
  - cd ${DISTDIR} || false
  - find . -maxdepth 1 -name '*.tar.gz' -exec tar -xvf '{}' \;
  # Generate cabal.project
  - rm -rf cabal.project cabal.project.local cabal.project.freeze
  - touch cabal.project
  - |
    echo 'packages: "base-compat-*/*.cabal"' >> cabal.project
    if [ ! "x$BATTERIES" = "xNO" ] ; then (echo 'packages: "base-compat-batteries-*/*.cabal"' >> cabal.project; echo 'packages: "type-check-*/*.cabal"' >> cabal.project) ; fi
  - |
    echo "write-ghc-environment-files: always" >> cabal.project
  - "for pkg in $($HCPKG list --simple-output); do echo $pkg | sed 's/-[^-]*$//' | (grep -vE -- '^(base-compat|base-compat-batteries|type-check)$' || true) | sed 's/^/constraints: /' | sed 's/$/ installed/' >> cabal.project.local; done"
  - cat cabal.project || true
  - cat cabal.project.local || true
  # Building...
  # this builds all libraries and executables (without tests/benchmarks)
  - ${CABAL} v2-build -w ${HC} --disable-tests --disable-benchmarks all
  # Building with tests and benchmarks...
  # build & run tests, build benchmarks
  - ${CABAL} v2-build -w ${HC} ${TEST} ${BENCH} all
  # Testing...
  - if [ $HCNUMVER -ge 70002 ] && [ $HCNUMVER -lt 70201 ]  ||  [ $HCNUMVER -ge 70202 ] && [ $HCNUMVER -lt 70401 ]  ||  [ $HCNUMVER -ge 70402 ] && [ $HCNUMVER -lt 70801 ]  ||  [ $HCNUMVER -ge 70802 ] ; then ${CABAL} v2-test -w ${HC} ${TEST} ${BENCH} all ; fi
  # cabal check...
  - (cd base-compat-* && ${CABAL} -vnormal check)
  - if [ ! "x$BATTERIES" = "xNO" ] ; then (cd base-compat-batteries-* && ${CABAL} -vnormal check) ; fi
  - if [ ! "x$BATTERIES" = "xNO" ] ; then (cd type-check-* && ${CABAL} -vnormal check) ; fi
  # haddock...
  - ${CABAL} v2-haddock -w ${HC} ${TEST} ${BENCH} all
  # Building without installed constraints for packages in global-db...
  - rm -f cabal.project.local
  - ${CABAL} v2-build -w ${HC} --disable-tests --disable-benchmarks all

# REGENDATA ["--output=.travis.yml","--config=cabal.haskell-ci","cabal.project"]
# EOF
